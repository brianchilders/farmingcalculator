<html>
<head>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css">
	<link rel="icon" type="image/png" href="img/favicon.png"/>
<style>
td, th {
    border: 1px solid black;
}

table {
    border-collapse: collapse;
}
</style>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8F1KR7LNV3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8F1KR7LNV3');
</script>
<script>
// Global variables
let current_price_ethereum = 0;
let current_price_swise = 0;
let current_price_1inch = 0;
let swap_ethereum_swise = 0;
let swap_ethereum_1inch = 0;
let amount_swise_invest = 0;
let amount_1inch_purchase = 0;
let estimated_apy = 0;
let days_left_to_farm = 0;
let total_value_swise = 0;
let total_cost_1inch = 0;
let farming_start_date = new Date();
let farming_end_date = new Date();
let swise_rewards_earned = 0;
let fiat_swise_rewards_earned = 0;
let 1inch_rewards_earned = 0;
let final_profit = 0;
let swise_1inch_ratio = 0;
// HTML values
// currprice_ethereum
// currprice_swise
// currprice_1inch
// startdate
// enddate
// amount_swise
// purchase_1inch
// apy
// final_profit
// swiseaward
// swiseawardfiat
// daysleft
// value_swise
// cost_1inch
</script>
<title>Farming Calculator Solution</title>
</head>

<body>

	<nav class="navbar is-transparent is-fixed">
		<div class="navbar-brand">
		  <a class="navbar-item" href="https://bulma.io">
			<img src="img/logo.svg" alt="Swise farming calculator" width="112" height="28">
		  </a>
		</div>
	  
		  <div class="navbar-end">
			<div class="navbar-item">
			  <div class="field is-grouped">
				<p class="control">
				  <a class="bd-tw-button button is-rounded" onClick="comingSoon()" data-tooltip="Tooltip Text">
					  Connect Wallet
				  </a>
				</p>
			  </div>
			</div>
		  </div>
		</div>
	  </nav>

	  <section class="section">
		<form name="spreadsheet" id="spreadsheet">
		<table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth'">
			<tr>
				<td>Current Price of ETH (USD)</td>
				<td><input type="text" id="currprice_ethereum"></td>
				<td>&nbsp;</td>
				<td>Days Left To Farm</td>
				<td><input type="text" id="days" value="30"></td>
				<td></td>
			</tr>
			<tr>
				<td>Current Price of SWISE (USD)</td>
				<td><input type="text" id="currprice_swise"></td>
				<td></td>
				<td>Total Value of SWISE</td>
				<td id="value_swise"></td>
				<td></td>
			</tr>
			<tr>
				<td>Current Price of 1inch (USD)</td>
				<td><input type="text" id="currprice_1inch"></td>
				<td></td>
				<td>Total Cost of 1inch</td>
				<td id="cost_1inch"></td>
				<td></td>
			</tr>
<tr>
<td>&nbsp;&nbsp;<br/>&nbsp;&nbsp;</td><td></td><td></td><td></td><td></td><td></td>
</tr>
<tr>
	<td>SWAP ETH to SWISE PRICE / LP Costs (USD)</td>
	<td><input id="swap_swise" value="0" onfocus="this.value=''"></td>
	<td></td>
	<td>Farming Start Date (TODAY)</td>
	<td id="startdate"></td>
	<td></td>
</tr>
<tr>
	<td>SWAP ETH to 1inch PRICE / LP Costs (USD)</td>
	<td><input id="swap_1inch" value="0" onfocus="this.value=''"></td>
	<td></td>
	<td>Farming End Date</td>
	<td id="enddate"></td>
	<td></td>
</tr>
<tr>
<td>&nbsp;&nbsp;<br/>&nbsp;&nbsp;</td><td></td><td></td><td></td><td></td><td></td>
</tr>
<tr>
	<td></td>
	<td></td>
	<td></td>
	<td>PRINCIPAL * ( (APY% / 100) / 365) * DAYS</td>
	<td>Unit</td>
	<td>Fiat</td>
</tr>
<tr>
	<td>Amount of SWISE investing</td>
	<td><input type="text" id="amount_swise"></td>
	<td></td>
	<td>SWISE Rewards Earned</td>
	<td id="swiseaward"></td>
	<td id="swiseawardfiat"></td>
</tr>
<tr>
	<td>Amount of 1inch need to purchase</td>
	<td id="purchase_1inch"></td>
	<td></td>
	<td>1inch Rewards Earned</td>
	<td>N/A</td>
	<td>N/A</td>
</tr>
<tr>
	<td>Estimated Actual APY (%)</td>
	<td><input type="text" id="apy" value="30"></td>
	<td></td>
	<td colspan=2>Final Profit (Assumes selling 1inch at current price and keeping SWISE)</td>
	<td id="finalprofitrealized" class="has-text-success is-bold has-background-success-light"></td>
</tr>
</table>
<input type="button" value="Calculate Farming Gains!" class="button is-link is-rounded" onClick="showCalculation()">
<br/>
<br/>
<table class="table is-bordered is-striped is-narrow is-hoverable">
<tr>
	<td colspan=5>Current Gas Prices (gwei)</td>
</tr>
<tr>
	<td>Last Updated</td>
	<td>Rapid</td>
	<td>Fast</td>
	<td>Standard</td>
	<td>Slow</td>
</tr>
<tr>
	<td><b id="timestamp"></b></td>
	<td><b id="rapid"></b></td>
	<td><b id="fast"></b></td>
	<td><b id="standard"></b></td>
	<td><b id="slow"></b></td>
	</tr>
	</table>
	</form>
</section>

<script>
let wsObj;
let wsUrl = 'wss://www.gasnow.org/ws';
let rapidObj = document.getElementById('rapid');
let fastObj = document.getElementById('fast');
let standardObj = document.getElementById('standard');
let slowObj = document.getElementById('slow');
// Update HTML with new gas prices
let updatePageGasPriceData = data => {
  console.log(data.gasPrices);
  if (data && data.gasPrices) {
    rapidObj.innerHTML = (data.gasPrices.rapid / 1000000000).toFixed(0);
    fastObj.innerHTML = (data.gasPrices.fast / 1000000000).toFixed(0);
    standardObj.innerHTML = (data.gasPrices.standard / 1000000000).toFixed(0);
    slowObj.innerHTML = (data.gasPrices.slow / 1000000000).toFixed(0);
  }
};
// open websocket connection
wsObj = new WebSocket(wsUrl);
wsObj.onopen = evt => {
  console.log("Connection opened.");
};
// handle the event
wsObj.onmessage = evt => {
  const dataStr = evt.data;
  const data = JSON.parse(dataStr);
  // if we have data, update the page
  if (data.type) {
    updatePageGasPriceData(data.data);
  }
};
// handle the close event
wsObj.onclose = evt => {
  console.log("Connection closed.");
};

// create function to parse json from a URL and store data
var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status === 200) {
        callback(null, xhr.response);
      } else {
        callback(status, xhr.response);
      }
    };
    xhr.send();
};

// Get Stakewise data
getJSON('https://api.coingecko.com/api/v3/coins/stakewise?localization=false&tickers=true&market_data=true&community_data=false&developer_data=false&sparkline=true',
function(err, data) {
  if (err !== null) {
    alert('Something went wrong: ' + err);
  } else {
    current_price_swise = data.market_data.current_price.usd;
	// change from td to input, use value instead of innerHTML
    currprice_swise.value = current_price_swise;
  }
});

// Get 1 inch data
getJSON('https://api.coingecko.com/api/v3/coins/1inch?localization=false&tickers=true&market_data=true&community_data=false&developer_data=false&sparkline=true',
function(err, data) {
  if (err !== null) {
    alert('Something went wrong: ' + err);
  } else {
    current_price_1inch = data.market_data.current_price.usd;
	// change from td to input, use value instead of innerHTML
    currprice_1inch.value = current_price_1inch;
  }
});

// Get Ethereum data
getJSON('https://api.coingecko.com/api/v3/coins/ethereum?localization=false&tickers=true&market_data=true&community_data=false&developer_data=false&sparkline=true',
function(err, data) {
  if (err !== null) {
    alert('Something went wrong: ' + err);
  } else {
    current_price_ethereum = data.market_data.current_price.usd;
	// change from td to input, use value instead of innerHTML
    currprice_ethereum.value = current_price_ethereum;
  }
});

window.onload = function() {
  startdate.innerHTML = new Date();
	enddate.innerHTML = new Date();
};

function comingSoon() {
	alert("This feature is coming soon");
}

function showCalculation() {
	// Calculate ratio
	swise_1inch_ratio = currprice_1inch.value / currprice_swise.value;

	// Determine how much 1inch to purchase
        amount_1inch_purchase = amount_swise.value / swise_1inch_ratio;

	// Update display
	purchase_1inch.innerHTML = amount_1inch_purchase;

	// Calculate fiat (USD) value of SWISE and (USD) purchase of 1inch
	total_value_swise = currprice_swise.value * amount_swise.value;
	total_cost_1inch = currprice_1inch.value * amount_1inch_purchase;

	// Update display for crypto dollar values
	value_swise.innerHTML = total_value_swise;
	cost_1inch.innerHTML = total_cost_1inch;

	// Update display
	startdate.innerHTML = new Date();
	enddate.innerHTML = "Date of end of farming for 1 inch";

	// Calculate rewards earned
	swise_rewards_earned = amount_swise.value * ((apy.value / 100) / 365) * days.value; 	
	// Convert to fiat
	fiat_swise_rewards_earned = swise_rewards_earned * current_price_swise;

	// Update display
	swiseaward.innerHTML = swise_rewards_earned;
	swiseawardfiat.innerHTML = fiat_swise_rewards_earned;

	// Compute profit / loss
	finalprofit = fiat_swise_rewards_earned - swap_swise.value - swap_1inch.value;	
	finalprofitrealized.innerHTML = finalprofit;
};
</script>
<section class="section">
<h3 class="title is-3">What this worksheet does:</h3>

1. The worksheet goes out to coingecko.com and fetches the latest prices for ETH, SWISE and 1inch.<br/>
2. The worksheet expects the user to put in a value for "Amount of SWISE investing".<br/>
3. The worksheet expects the user to put in "Estimated Actual APY (%)" (in percent).<br/>
4. The worksheet expects the user to put in "Days Left To Farm".<br/>
5. Then press the "Calculate farming Gains!" button.<br/>
6. The worksheet will calculate the amount of 1inch that will need to be purchased to maintain a 1:1 parity in USD and display that in the "Amount of 1inch need to purchase" field.<br/>
7. The worksheet will calculate the fiat value of SWISE and 1inch (in USD).<br/>
8.  Given the formula PRINCIPAL * ((APY %/ 100) / 365) * DAYS, it calculates the potential SWISE Rewards Earned and the corresponding Fiat Value.<br/>
9. The cost of doing the LP is deducted from the earned SWISE Fiat value.  This is "net profit realized".  It is assumed that the 1inch that was bought will also be sold, as it will not be possible to earn 1inch rewards, and sold for at least the same price it was bought for.  In order to even "make a profit", the 1inch tokens need to be sold.
<br/>
<br/>
</section>

<footer class="footer">
  <div class="content has-text-centered">
    <p>
      Made with &#x2665; by ShornEvans, Quick and brianchilders for the StakeWise community.
			Eat Steak be Wise.
    </p>
  </div>
</footer>

</body>
</html>
